<html>
	<head>
		<title>
			INSTA Wingman
		</title>
		
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="css/index.css">
		
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=100%" />
	</head>
	
	<body>
		<header class="container">
			<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0">
				<h1>
					<i class="fa fa-instagram"></i>
					INSTA Wingman bookmarklet
				</h1>
				
				<a onclick="javascript:$('#HowToAddToMobile').modal();" class="right">
					<i class="fa fa-mobile"></i>
					Add it to your mobile phone
				</a>
			</div>
		</header>
		
		<div class="masthead">
			<div class="container">
				<!---->
				<div class="logo">
					<i class="fa fa-instagram"></i>
					INSTA WINGMAN
					<span>
						<i class="fa fa-code"></i>
						DEVELOPER BOOKMARKLET
					</span>
				</div>
				<!---->
				
				<div class="row col-md-10 col-xs-12 col-md-offset-1 col-xs-offset-0">
					<div class="promo_text lead">
						The Wingman that brings you followers.
					</div>
				</div>
				
				<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0">
					<div id="DragLink" class="btn-primary btn-primary-inverse masthead_link">
						<a id="DesktopLink" class="js_desktop_code_to_href">
							INSTA Wingman
						</a>
						
						<i class="fa fa-hand-o-up"></i>
						Drag me into your link bar
					</div>
					
					<!--
					<div class="explain">
						After that go to a webpage and click the bookmarklet
						<a>?</a>
					</div>
					<!---->
				</div>
			</div>
		</div>
		
		<div class="container">
			<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0 main">
				<h3>This is how you use it</h3>
				
				<br />
				<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
					<!-- Indicators -->
					<ol class="carousel-indicators">
						<li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
						<li data-target="#carousel-example-generic" data-slide-to="1"></li>
						<li data-target="#carousel-example-generic" data-slide-to="2"></li>
						<li data-target="#carousel-example-generic" data-slide-to="3"></li>
					</ol>

					<!-- Wrapper for slides -->
					<div class="carousel-inner" role="listbox">
						<div class="item active">
							<img src="images/howToUse_1.jpg" class="img-responsive" />
							<div class="carousel-caption">
								Go somewhere
							</div>
						</div>
						<div class="item">
							<img src="images/howToUse_2.jpg" class="img-responsive" />
							<div class="carousel-caption">
								Click the bookmarklet
							</div>
						</div>
						<div class="item">
							<img src="images/howToUse_3.jpg" class="img-responsive" />
							<div class="carousel-caption">
								<i class="fa fa-star"></i> The performance bar appears <i class="fa fa-star"></i>
							</div>
						</div>
						<div class="item">
							<img src="images/howToUse_4.jpg" class="img-responsive" />
							<div class="carousel-caption">
								To get realistic results, clear cache before use.
							</div>
						</div>
					</div>

					<!-- Controls -->
					<a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
						<i class="glyphicon-chevron-left fa fa-chevron-left" aria-hidden="true"></i>
						<span class="sr-only">Previous</span>
					</a>
					<a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
						<i class="glyphicon-chevron-right fa fa-chevron-right" aria-hidden="true"></i> 
						<span class="sr-only">Next</span>
					</a>
				</div>
				
				<br />
				
				<h3>Enjoy your wingman.</h3>
				
				<!--
				<br />
				<br />
				
				<a href="https://github.com/thnew/insta-wingman/" class="btn-primary">
					<i class="fa fa-github"></i> View on GitHub
				</a>
				<!---->
			</div>
		</div>
		
		<div class="page_separator"></div>
		
		<footer class="container">
			<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0">
				<span class="pull-right">
					go to <a href="?developer">developer mode</a> | by Thomas Heigl
				</span>
			</div>
		</footer>
		
		<div id="HowToAddModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">No Bro, you didn't click me! Did you?</h4>
					</div>
					<div class="modal-body">
						<p>You have to drag the button and drop it into your link bar!</p>
						
						<img class="img-responsive" src="images/explain.jpg" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Ok, got it!</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div id="HowToAddToMobile" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">How to add it to your smartphone</h4>
					</div>
					<div class="modal-body">
						<h5>
							Follow these instructions
						</h5>
						
						<ol id="MobileInstruction" class="s1">
							<li class="s1">1. Click this link: <a id="MobileLink" onclick="changeToStep(2)">INSTA Wingman</a></li>
							<li class="s2">
								2. Bookmark this page<br />
								<button class="btn" onclick="changeToStep(3)">ok, did it!</button>
							</li>
							<li class="s3">3.
								Edit the bookmark URL and remove everything up to and including the hash ("#")
								so that the bookmark URL starts with "javascript:"
								<br />
								Example:
								<br />
								<img class="img-responsive" src="images/mobileAddBokkmarkletExample.png" />
							</li>
						</ol>
						
						<h5>
							Or create a new bookmark with following URL
						</h5>
						
						<input class="form-control js_desktop_code_to_value" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Alright!</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div id="HowToUseModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">You didn't understand? Ok let me explain.</h4>
					</div>
					<div class="modal-body">
						<p>You go to a random webpage. Click at the bookmarklet. And that's it..</p>
						
						<img class="img-responsive" src="images/howToUse.jpg" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Ahh, I understand!</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<script src="js/jquery.min.js" type="text/javascript"></script>
		<script src="js/bootstrap.min.js" type="text/javascript"></script>
		
		<script>
			(function(){
				function setJsLinks(content) {
					content = content.replace(new RegExp("\n", 'g'), "");
					content = content.replace(new RegExp("\t", 'g'), "");
					
					var linkElems = document.querySelectorAll(".js_desktop_code_to_href");
					for(var f in linkElems)
					{
						linkElems[f].href = content;
					}
					
					linkElems = document.querySelectorAll(".js_desktop_code_to_value");
					for(var f in linkElems)
					{
						linkElems[f].value = content;
					}
					
					document.querySelector("#MobileLink").href = "#" + content;
				};
				
				function scriptLoadFunction(scriptPath){
					var isLocal = ((self.location+"").split("http://").pop().split("/")[0] == "localhost:8080");
					
					if(scriptPath == null)
					{
						scriptPath = (isLocal ?
							"bookmarklet.js"
							: "https://thnew.github.io/insta-wingman/public/bookmarklet.js");
					}
					
					var body = document.getElementsByTagName("body")[0];
					
					var loadingElem = document.createElement("div");
					loadingElem.id = "InstaWingmanLoadingHint";
					loadingElem.innerHTML = "Wingman is coming to you...";
					loadingElem.style.cssText = "color:#fff;position:absolute;top:0;left:0;background-color:#000;padding:5;box-shadow:0 0 5px #000;";
					
					var jselem = document.createElement("script");
					jselem.type = "text/javascript";
					jselem.src = scriptPath;
					jselem.onload = function() {
						body.removeChild(loadingElem);
					};
					
					body.appendChild(loadingElem).appendChild(jselem);
				};
				
				function scriptLoadFunctionConsole() {
					$("body").children().hide();
					
					var actionsToBePerformed = [];
					
					/* Perform an console action */
					function performAction(value, action, callback) {
						/* In those cases the value will be an URL */
						if(["giveloveto", "follow", "unfollow", "like"].indexOf(action.toLowerCase()) != -1) {
							var iFrame = $("<iframe>")
								.attr("Id", "InstaWindow")
								.attr("src", value)
								.css("z-index", 10)
								.css("border", "0px")
								.height("100%")
								.width("100%")
								.load(function(){
									if(timeout == null) {
										console.log("I won't execute cause the Timeout was already executed");
										return;
									}
									
									/* Clear the timeout */
									window.clearTimeout(timeout);
									
									window.setTimeout(function() {
										var iframe = $("#InstaWindow");

										try {
											var iFrameContent = iframe.contents();

											/*Remove images to make loading faster*/
											$("img", iFrameContent).remove();
											
											switch(action.toLowerCase()) {
												case "giveloveto":
													var media = $("._8mlbc", iFrameContent);
													
													var potentialTasks = [];
													
													media.each(function(key, value){
														href = $(value).attr("href");
														
														potentialTasks.push({
															action:		"like",
															imageUrl:	"https://www.instagram.com" + href
														});
													});

													var waittime = Math.round(Math.random() * 21 + 5) * 1000;

													if(waittime == 25) waittime = Math.round(Math.random() * 20 + 50) * 1000;
													
													actionsToBePerformed.push({
														action:		"wait",
														waittime:	waittime /* Wait time between 50s and 3min */
														/*waittime:	Math.round(Math.random() * 130 + 50) * 1000 /* Wait time between 50s and 3min */
													});
													
													/* Between 2 and 4 */
													var amountOfImagesToLike = Math.round(Math.random()*2 + 2);
													var stepSize = Math.round(potentialTasks.length / amountOfImagesToLike);
													stepSize = 999; /*Make it temporarily big to let just one photo be liked*/

													for(var i=0; i<potentialTasks.length; i+=stepSize) {
														actionsToBePerformed.push(potentialTasks[i]);
													}
													
													console.log("actionsToBePerformed.length: " + actionsToBePerformed.length);
													break;
												case "like":
													var likeBtn = $("._1tv0k[data-reactid='.0.1.0.0.0.2.2.0'] > span[class~='whiteoutSpriteHeartOpen']", iFrameContent);
													
													if(likeBtn.length == 0) {
														console.log("Like button not found");
													}
													
													likeBtn.click();
													break;
												case "follow":
													var btn = $("._2hpcs[data-reactid='.0.1.0.0:0.1.0.2.0']", iFrameContent);
													
													if(btn.length == 0) {
														console.log("Unfollow button not found");
													}
													
													btn.click();
													break;
												case "unfollow":
													var btn = $("._r4e4p[data-reactid='.0.1.0.0:0.1.2.0.0']", iFrameContent);
													
													if(btn.length == 0) {
														console.log("Unfollow button not found");
													}
													
													btn.click();
													break;
												default:
													console.log("Action " + action.toLowerCase() + " not found");
											}
										}
										catch(e) {}

										var timeout = window.setTimeout(function() {
											wrapper.remove();
											
											timeout = null;
											
											callback();
										}, 1000);
									}, 1000);
								});
							
							/* If the IFrame doesn't load, remove it after a time */
							var timeout = window.setTimeout(function() {
								console.log("The action will be exited cause of a timeout");
								
								exited = true;
								
								wrapper.remove();

								callback();
							}, 30000);
						}
						
						var overlay = $("<div>")
							.css("position", "absolute")
							.css("top", "0px")
							.css("left", "0px")
							.css("right", "0px")
							.css("bottom", "0px")
							.css("z-index", 11)
							.css("text-align", "center")
							.css("color", "rgba(0,0,0,0,8)")
							.css("padding-top", "70px")
							.css("font-family", "Arial")
							.text(action.toLowerCase())
							.css("background-color", "rgba(255,255,255,0.8)");
						
						var wrapper = $("<div>")
							.append(iFrame)
							.append(overlay)
							.css("position", "fixed")
							.css("top", "0px")
							.css("right", "0px")
							.width(550)
							.height(550);
						
						$("body").append(wrapper);
						
						/* If the console should wait */
						if(action.toLowerCase() == "wait") {
							var startTime = new Date().getTime();
							var waitInterval = window.setInterval(function() {
								var executeTime = new Date().getTime() - startTime;
								var remaining = value - executeTime;
								
								if(remaining < 0) {
									window.clearInterval(waitInterval);
									
									wrapper.remove();

									callback();
								}
								else {
									overlay.text(action.toLowerCase() + " " + (Math.round(remaining / 1000)) + "s");
								}
							}, 100);
						}
					}
					
					function executeCommands() {
						var textarea = $("#Commands");
						var commands = textarea.val().split("\n");
						
						console.log(commands.length + " text commands found.");
						
						actionsToBePerformed = actionsToBePerformed || [];
						
						for(var f in commands) {
							var command = commands[f];
							var parts = command.split(" ");

							var action = parts[0].toLowerCase();

							switch(action) {
								case "unfollow":
									var username = parts.length > 1 ? parts[1] : null;
									
									if(username == null) {
										alert("Command '" + command + "' not recognized!");
										break;
									}
									
									actionsToBePerformed.push({
										user: new User({
											Name: username
										}),
										action: action
									});
									break;
								case "giveloveto":
									var username = parts.length > 1 ? parts[1] : null;
									
									if(username == null) {
										alert("Command '" + command + "' not recognized!");
										break;
									}
									
									actionsToBePerformed.push({
										user: new User({
											Name: username
										}),
										action: action
									});
									break;
								case "wait":
									var waittime = parts.length > 1 ? parts[1] : null;
									
									if(waittime == null) {
										alert("Command '" + command + "' not recognized!");
										break;
									}
									
									actionsToBePerformed.push({
										waittime: waittime,
										action: action
									});
									break;
								default:
									alert("Command '" + command + "' not recognized!");
							}
						}
						
						var executeStepByStep = function(tasks) {
							if(tasks.length == 0) {
								return;
							}

							/*var task = tasks.pop();*/
							/*Take first*/
							var task = tasks[0];
							/*Remove first*/
							tasks.splice(0, 1);
							
							if(task.action.toLowerCase() == "wait") {
								performAction(task.waittime, task.action, function() {
									console.log(tasks.length + " tasks remaining.");
									
									/*Execute the remaining tasks*/
									executeStepByStep(tasks);
								});
							}
							else if(task.action.toLowerCase() == "like") {
								performAction(task.imageUrl, task.action, function() {
									console.log(tasks.length + " tasks remaining.");
									
									/*Execute the remaining tasks*/
									executeStepByStep(tasks);
								});
							}
							else if(["follow", "unfollow", "giveloveto"].indexOf(task.action.toLowerCase()) > 0) {
								task.user.PerformAction(task.action, function() {
									console.log(tasks.length + " tasks remaining.");
									
									/*Execute the remaining tasks*/
									executeStepByStep(tasks);
								});
							}
						};

						console.log("Execute " + actionsToBePerformed.length + " tasks.");
						
						executeStepByStep(actionsToBePerformed);
					}

					var textarea = $("<textarea>")
						.attr("Id", "Commands")
						.css("height", "100px")
						.width("100%")
						.keyup(function(e){
							if(e.keyCode == 13 && e.ctrlKey) {
								executeCommands();
							}
						});
					  
					var btn = $("<button>")
						.text("Execute")
					  .click(executeCommands);
					  
					$("<div>")
						.css("position", "fixed")
						.css("top", "0px")
						.css("left", "0px")
						.height(130)
						.width(300)
						.append(textarea)
						.append(btn)
						.appendTo("body");
					  
					  
					/* Class User */ {
						function User(attr) {
							for(var f in attr) {
								this[f] = attr[f];
							}
							
							this.Url = "https://www.instagram.com/" + attr.Name;

							/*Some commands*/
							this.CmdUnfollow = "unfollow " + attr.Name;
							this.CmdFollow = "follow " + attr.Name;
							this.CmdGiveLoveTo = "giveloveto " + attr.Name;
						};
						
						User.prototype = {
							Name: null,
							Url: null,
							IsPrivate: null,
							
							Posts: null,
							Followers: null,
							Follows: null,
							
							MostLikesOnFirstPage: null,
							TotalLikesOnFirstPage: null,

							/*Commands*/
							CmdUnfollow: null,
							CmdFollow: null,
							CmdGiveLoveTo: null,
							
							Semaphore: new Semaphore(1),
							
							GetHeaderAttributes: function() {
								return [
									"Name",
									"Url",
									"Posts",
									"Followers",
									"Follows",
									"IsPrivate",
									"MostLikesOnFirstPage",
									"TotalLikesOnFirstPage",
									"CmdUnfollow",
									"CmdFollow",
									"CmdGiveLoveTo"
								];
							},
							
							LoadInfo: function(callback) {
								var me = this;
								
								me.Semaphore.take(function() {
								$.get(me.Url, function(resp) {
										console.log("Analyze " + me.Name);
										
									var sharedData = resp.split("window._sharedData =");
									sharedData = sharedData.pop();
									sharedData = sharedData.split(";<\/script>")[0];
									sharedData = sharedData.trim();
										
									try {
										sharedData = JSON.parse(sharedData);
									}
									catch(e) {
										console.log("LoadInfo() - response sharedData could not be JSON parsed: ", sharedData);
											
										callback({
											success: false,
											data: me
										});
									}
										
									var user = sharedData.entry_data.ProfilePage[0].user;
										
									resp = $(resp);
										
									me.Posts = user.media.count;
									me.Followers = user.followed_by.count;
									me.Follows = user.follows.count;
										me.IsPrivate = user.is_private;
										
										if(!me.IsPrivate) {
									var mostLikes = 0;
									var totalLikes = 0;
									for(var f in user.media.nodes) {
										var media = user.media.nodes[f];
										if(media.likes.count > mostLikes) {
											mostLikes = media.likes.count;
										}
												
										totalLikes += media.likes.count;
									}
											
									me.MostLikesOnFirstPage = mostLikes;
									me.TotalLikesOnFirstPage = totalLikes;
										}
										
									callback({
										success: true,
										data: me
									});
										
										me.Semaphore.leave();
									}).fail(function() {
									callback({
										success: false,
										data: null
									});
										
										me.Semaphore.leave();
								});
								});
							}
						};
					}
				};
				
				function scriptLoadFunctionFeed2Excel() {
					window.setTimeout(function(){
						var allUsers = [];
						
						var feedMedia = window._sharedData.entry_data.FeedPage.pop().feed.media.nodes;
						
						/* Go through the own feed */
						for(var f in feedMedia) {
							var media = feedMedia[f];
							allUsers.push(new User({
								Name: media.owner.username
							}));
							
							/* Go through the likes of the media */
							for(var g in media.likes.nodes) {
								var like = media.likes.nodes[g];
								
								allUsers.push(new User({
									Name: like.user.username
								}));
							}
						}
						
						loadAllUserInfos(allUsers, function(users) {
							console.log("Users", users);
							alert("Finished loading users. Downlaod starts now.");
							
							/* Start download */
							downloadUsersAsCsv(users);
						})
					}, 0);
					
					function loadAllUserInfos(userList, callback) {
						var usersToLoad = userList.length;
						
						for(var f in userList) {
							var user = userList[f];
							
							user.LoadInfo(function(resp) {
								if(--usersToLoad == 0) {
									console.log("loadAllUserInfos() - All users loaded!");
									callback(userList);
									return;
								}
								
								console.log("loadAllUserInfos() - Load " + usersToLoad + " more users.");
							});
						}
					};
					
					function downloadUsersAsCsv(users) {
						if(users.length == 0) {
							alert("No users found to download!");
							return;
						}
						
						var header = users[0].GetHeaderAttributes();
						
						var usersArray = [];
						
						for(var f in users) {
							var user = users[f];
							var userAsAnArray = [];
							
							for(var g in header) {
								attrName = header[g];
								userAsAnArray.push(user[attrName]);
							}
							
							usersArray.push(userAsAnArray);
						}
						
						var csvContent = header.join(";") + "\n";
						usersArray.forEach(function(infoArray, index){
							dataString = infoArray.join(";");
							csvContent += dataString+ "\n";
						});

						var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
						var link = document.createElement("a");
						var url = URL.createObjectURL(blob);
						link.setAttribute("href", url);
						link.setAttribute("download", 'data.csv');
						link.style.visibility = 'hidden';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
					};
					
					
					
					/* Semaphore */ {
						function Semaphore(capacity) {
							var semaphore = {
								capacity: capacity || 1,
								current: 0,		
								queue: [],

								take: function() {
									var item = { n: 1 };

									if (typeof arguments[0] == 'function') item.task = arguments[0];
									else if (typeof arguments[0] == 'object') item.args = arguments[0];
									else item.n = arguments[0];

									if (arguments.length == 2)  {
										if (typeof arguments[1] == 'function') item.task = arguments[1];
										else if (typeof arguments[1] == 'object') item.args = arguments[1];
										else item.n = arguments[1];
									}
									
									if (arguments.length == 3)  {
										if (typeof arguments[2] == 'function') item.task = arguments[2];
										else if (typeof arguments[2] == 'object') item.args = arguments[2];
										else item.n = arguments[2];
									}

									if (semaphore.current + item.n > semaphore.capacity) {
										return semaphore.queue.push(item);
									}

									semaphore.current += item.n;
									item.task(item.args);
								},

								leave: function(n) {
									n = n || 1;

									semaphore.current -= n;
									
									if (!semaphore.queue.length) {
										if (semaphore.current < 0) {
											throw new Error('leave called too many times.');
										}

										return;
									}

									var item = semaphore.queue[0];

									if (item.n + semaphore.current > semaphore.capacity) {
										return;
									}

									semaphore.queue = semaphore.queue.splice(1);
									semaphore.current += item.n;
									
									item.task(item.args);
								}
							};

							return semaphore
						};
					}
					
					/* Class User */ {
						function User(attr) {
							for(var f in attr) {
								this[f] = attr[f];
							}
							
							this.Url = "https://www.instagram.com/" + attr.Name;

							/*Some commands*/
							this.CmdUnfollow = "unfollow " + attr.Name;
							this.CmdFollow = "follow " + attr.Name;
							this.CmdGiveLoveTo = "giveloveto " + attr.Name;
						};
						
						User.prototype = {
							Name: null,
							Url: null,
							IsPrivate: null,
							
							Posts: null,
							Followers: null,
							Follows: null,
							
							MostLikesOnFirstPage: null,
							TotalLikesOnFirstPage: null,

							/*Commands*/
							CmdUnfollow: null,
							CmdFollow: null,
							CmdGiveLoveTo: null,
							
							Semaphore: new Semaphore(1),
							
							GetHeaderAttributes: function() {
								return [
									"Name",
									"Url",
									"Posts",
									"Followers",
									"Follows",
									"IsPrivate",
									"MostLikesOnFirstPage",
									"TotalLikesOnFirstPage",
									"CmdUnfollow",
									"CmdFollow",
									"CmdGiveLoveTo"
								];
							},
							
							LoadInfo: function(callback) {
								var me = this;
								
								me.Semaphore.take(function() {
									$.get(me.Url, function(resp) {
										console.log("Analyze " + me.Name);
										
										var sharedData = resp.split("window._sharedData =");
										sharedData = sharedData.pop();
										sharedData = sharedData.split(";<\/script>")[0];
										sharedData = sharedData.trim();
										
										try {
											sharedData = JSON.parse(sharedData);
										}
										catch(e) {
											console.log("LoadInfo() - response sharedData could not be JSON parsed: ", sharedData);
											
											callback({
												success: false,
												data: me
											});
										}
										
										var user = sharedData.entry_data.ProfilePage[0].user;
										
										resp = $(resp);
										
										me.Posts = user.media.count;
										me.Followers = user.followed_by.count;
										me.Follows = user.follows.count;
										me.IsPrivate = user.is_private;
										
										if(!me.IsPrivate) {
											var mostLikes = 0;
											var totalLikes = 0;
											for(var f in user.media.nodes) {
												var media = user.media.nodes[f];
												if(media.likes.count > mostLikes) {
													mostLikes = media.likes.count;
												}
												
												totalLikes += media.likes.count;
											}
											
											me.MostLikesOnFirstPage = mostLikes;
											me.TotalLikesOnFirstPage = totalLikes;
										}
										
										callback({
											success: true,
											data: me
										});
										
										me.Semaphore.leave();
									}).fail(function() {
										callback({
											success: false,
											data: null
										});
										
										me.Semaphore.leave();
									});
								});
							}
						};
					}
				};
				
				// TEMPORARY
				function scriptLoadFunctionExcel() {
					/* wrapper */
					$("._n3cp9");
					
					/* list */
					var userListElem = $("._4j13h");
					
					var scrollContainer = $("._4gt3b");
					
					var getFollowButtons = function() {
						return $("._csba8[data-reactid]", userListElem);
					};
					
					var followTwentyUsers = function() {
						getFollowButtons().slice(0, 20).click();
					};
					
					var getUsers = function() {
						var users = [];
						
						/* Go through the list and grab all the user names */
						$("._4zhc5", userListElem).each(function(index, value){
							var elem = $(value);
							var name = elem.text();
							
							users.push(new User({
								Name: name
							}));
						});
						
						return users;
					};
					
					var loadMoreUsers = function() {
						console.log("loadMoreUsers()");
						scrollContainer.scrollTop(Math.pow(2,32));
					};
					
					/* Helper */ {
						var INT_MAX = Math.pow(2,32);
						
						var getMilliseconds = function() {
							return Date.UTC(0,0,0,0,new Date().getMinutes(),new Date().getSeconds());
						};
					}
					
					/*Scroll down as long as new followers appear or the wanted amount is reached*/
					function loadUsers(usersToLoad, updateCallback, successCallback) {
						var amountOfUsers = 0;
						if(amountOfUsers < usersToLoad)
						{
							var maxWaitingTime = 2000;
							
							var lastSuccessTime = getMilliseconds();
							
							/* Watch */
							var interval = window.setInterval(function(){
								console.log("Check");
								
								var timeSinceLastSuccess = getMilliseconds() - lastSuccessTime;
								
								var users = getUsers();
								
								if(users.length > amountOfUsers) {
									lastSuccessTime = getMilliseconds();
									amountOfUsers = users.length;

									updateCallback(amountOfUsers);
									
									if(amountOfUsers >= usersToLoad) {
										window.clearInterval(interval);
										successCallback(amountOfUsers);
										return;
									}
									
									console.log("Too less users: " + amountOfUsers + ". Try to load more users.");
									loadMoreUsers();
									return;
								}
								
								if(timeSinceLastSuccess > maxWaitingTime) {
									window.clearInterval(interval);
									successCallback(amountOfUsers);
									return;
								}
							}, 50);
						}
					};
					
					function loadAllUserInfos(userList, callback) {
						var usersToLoad = userList.length;
						
						for(var f in userList) {
							var user = userList[f];
							
							user.LoadInfo(function(resp) {
								if(--usersToLoad == 0) {
									console.log("loadAllUserInfos() - All users loaded!");
									callback(userList);
									return;
								}
								
								console.log("loadAllUserInfos() - Load " + usersToLoad + " more users.");
							});
						}
					};
					
					loadUsers(INT_MAX, function(usersLoaded) {
						$("._q44m8 span").remove();
						$("._q44m8").append($("<span>").text(usersLoaded + " users loaded."));
					}, function(usersLoaded) {
						var users = getUsers();
						
						console.log(users);
						
						loadAllUserInfos(users, function(users) {
							console.log("Users", users);
							alert("Finished loading users. Downlaod starts now.");
							
							/* Start download */
							downloadUsersAsCsv(users);
						});
					});
					
					function downloadUsersAsCsv(users) {
						if(users.length == 0) {
							alert("No users found to download!");
							return;
						}
						
						var header = users[0].GetHeaderAttributes();
						
						var usersArray = [];
						
						for(var f in users) {
							var user = users[f];
							var userAsAnArray = [];
							
							for(var g in header) {
								attrName = header[g];
								userAsAnArray.push(user[attrName]);
							}
							
							usersArray.push(userAsAnArray);
						}
						
						var csvContent = header.join(";") + "\n";
						usersArray.forEach(function(infoArray, index){
							dataString = infoArray.join(";");
							csvContent += dataString+ "\n";
						});

						var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
						var link = document.createElement("a");
						var url = URL.createObjectURL(blob);
						link.setAttribute("href", url);
						link.setAttribute("download", 'data.csv');
						link.style.visibility = 'hidden';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
					};
					
					/* Semaphore */ {
						function Semaphore(capacity) {
							var semaphore = {
								capacity: capacity || 1,
								current: 0,		
								queue: [],

								take: function() {
									var item = { n: 1 };

									if (typeof arguments[0] == 'function') item.task = arguments[0];
									else if (typeof arguments[0] == 'object') item.args = arguments[0];
									else item.n = arguments[0];

									if (arguments.length == 2)  {
										if (typeof arguments[1] == 'function') item.task = arguments[1];
										else if (typeof arguments[1] == 'object') item.args = arguments[1];
										else item.n = arguments[1];
									}
									
									if (arguments.length == 3)  {
										if (typeof arguments[2] == 'function') item.task = arguments[2];
										else if (typeof arguments[2] == 'object') item.args = arguments[2];
										else item.n = arguments[2];
									}

									if (semaphore.current + item.n > semaphore.capacity) {
										return semaphore.queue.push(item);
									}

									semaphore.current += item.n;
									item.task(item.args);
								},

								leave: function(n) {
									n = n || 1;

									semaphore.current -= n;
									
									if (!semaphore.queue.length) {
										if (semaphore.current < 0) {
											throw new Error('leave called too many times.');
										}

										return;
									}

									var item = semaphore.queue[0];

									if (item.n + semaphore.current > semaphore.capacity) {
										return;
									}

									semaphore.queue = semaphore.queue.splice(1);
									semaphore.current += item.n;
									
									item.task(item.args);
								}
							};

							return semaphore
						};
					}
					
					/* Class User */ {
						function User(attr) {
							for(var f in attr) {
								this[f] = attr[f];
							}
							
							this.Url = "https://www.instagram.com/" + attr.Name;

							/*Some commands*/
							this.CmdUnfollow = "unfollow " + attr.Name;
							this.CmdFollow = "follow " + attr.Name;
							this.CmdGiveLoveTo = "giveloveto " + attr.Name;
						};
						
						User.prototype = {
							Name: null,
							Url: null,
							IsPrivate: null,
							
							Posts: null,
							Followers: null,
							Follows: null,
							
							MostLikesOnFirstPage: null,
							TotalLikesOnFirstPage: null,

							/*Commands*/
							CmdUnfollow: null,
							CmdFollow: null,
							CmdGiveLoveTo: null,
							
							Semaphore: new Semaphore(1),
							
							GetHeaderAttributes: function() {
								return [
									"Name",
									"Url",
									"Posts",
									"Followers",
									"Follows",
									"IsPrivate",
									"MostLikesOnFirstPage",
									"TotalLikesOnFirstPage",
									"CmdUnfollow",
									"CmdFollow",
									"CmdGiveLoveTo"
								];
							},
							
							LoadInfo: function(callback) {
								var me = this;
								
								me.Semaphore.take(function() {
									$.get(me.Url, function(resp) {
										console.log("Analyze " + me.Name);
										
										var sharedData = resp.split("window._sharedData =");
										sharedData = sharedData.pop();
										sharedData = sharedData.split(";<\/script>")[0];
										sharedData = sharedData.trim();
										
										try {
											sharedData = JSON.parse(sharedData);
										}
										catch(e) {
											console.log("LoadInfo() - response sharedData could not be JSON parsed: ", sharedData);
											
											callback({
												success: false,
												data: me
											});
										}
										
										var user = sharedData.entry_data.ProfilePage[0].user;
										
										resp = $(resp);
										
										me.Posts = user.media.count;
										me.Followers = user.followed_by.count;
										me.Follows = user.follows.count;
										me.IsPrivate = user.is_private;
										
										if(!me.IsPrivate) {
											var mostLikes = 0;
											var totalLikes = 0;
											for(var f in user.media.nodes) {
												var media = user.media.nodes[f];
												if(media.likes.count > mostLikes) {
													mostLikes = media.likes.count;
												}
												
												totalLikes += media.likes.count;
											}
											
											me.MostLikesOnFirstPage = mostLikes;
											me.TotalLikesOnFirstPage = totalLikes;
										}
										
										callback({
											success: true,
											data: me
										});
										
										me.Semaphore.leave();
									}).fail(function() {
										callback({
											success: false,
											data: null
										});
										
										me.Semaphore.leave();
									});
								});
							}
						};
					}
				};
				// /TEMPORARY
				
				setJsLinks('javascript:(' + scriptLoadFunctionFeed2Excel + ')();');
				
				(function() {
					/*Get GET-parameters*/ {
						var _GET = {};
						var parts = location.href.split("?");
						
						if(parts.length > 1)
						{
							parts = parts.pop();
							parts = parts.split("#")[0];
							parts = parts.split("&");
							
							for(var f in parts)
							{
								var p = parts[f].split("=");
								
								_GET[p[0]] = (p.length > 1 ? p[1] : true);
							}
						}
					}
					
					// If developer set, modify bookmarklet URL
					if(_GET["developer"] != null)
					{
						setJsLinks('javascript:var isDevelopmentMode=true; ' + scriptLoadFunction + '; scriptLoadFunction("https://thnew.github.io/insta-wingman/public/bookmarklet.js");');
						
						document.querySelector("#DesktopLink").innerHTML += " DEV";
						
						// Show visually, that this is the developer mode
						var logoSub = $(".logo span");
						
						logoSub.css("font-size", 10);
					}
					
					if(_GET["developer"] == null)
					{
						var dragLink = document.querySelector("#DragLink");
						dragLink.onclick = function() {
							var style = document.createElement("style");
							style.innerHTML += "#PerfBar { display: none !important; }";
							document.head.appendChild(style);
							
							$("#HowToAddModal").modal();
						};
					}
				})();
				
				$(".explain").click(function() {
					$("#HowToUseModal").modal();
				});
			})();
			
			function changeToStep(nr){
				document.querySelector("#MobileInstruction").className = "s" + nr;
			}
		</script>
	</body>
</html>