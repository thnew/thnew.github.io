<html>
	<head>
		<title>
			INSTA Wingman
		</title>
		
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="css/index.css">
		
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=100%" />
	</head>
	
	<body>
		<header class="container">
			<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0">
				<h1>
					<i class="fa fa-instagram"></i>
					INSTA Wingman bookmarklet
				</h1>
				
				<a onclick="javascript:$('#HowToAddToMobile').modal();" class="right">
					<i class="fa fa-mobile"></i>
					Add it to your mobile phone
				</a>
			</div>
		</header>
		
		<div class="masthead">
			<div class="container">
				<!---->
				<div class="logo">
					<i class="fa fa-instagram"></i>
					INSTA WINGMAN
					<span>
						<i class="fa fa-code"></i>
						DEVELOPER BOOKMARKLET
					</span>
				</div>
				<!---->
				
				<div class="row col-md-10 col-xs-12 col-md-offset-1 col-xs-offset-0">
					<div class="promo_text lead">
						The Wingman that brings you followers.
					</div>
				</div>
				
				<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0">
					<div id="DragLink" class="btn-primary btn-primary-inverse masthead_link">
						<a id="DesktopLink" class="js_desktop_code_to_href">
							INSTA Wingman
						</a>
						
						<i class="fa fa-hand-o-up"></i>
						Drag me into your link bar
					</div>
					
					<!--
					<div class="explain">
						After that go to a webpage and click the bookmarklet
						<a>?</a>
					</div>
					<!---->
				</div>
			</div>
		</div>
		
		<div class="container">
			<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0 main">
				<h3>This is how you use it</h3>
				
				<br />
				<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
					<!-- Indicators -->
					<ol class="carousel-indicators">
						<li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
						<li data-target="#carousel-example-generic" data-slide-to="1"></li>
						<li data-target="#carousel-example-generic" data-slide-to="2"></li>
						<li data-target="#carousel-example-generic" data-slide-to="3"></li>
					</ol>

					<!-- Wrapper for slides -->
					<div class="carousel-inner" role="listbox">
						<div class="item active">
							<img src="images/howToUse_1.jpg" class="img-responsive" />
							<div class="carousel-caption">
								Go somewhere
							</div>
						</div>
						<div class="item">
							<img src="images/howToUse_2.jpg" class="img-responsive" />
							<div class="carousel-caption">
								Click the bookmarklet
							</div>
						</div>
						<div class="item">
							<img src="images/howToUse_3.jpg" class="img-responsive" />
							<div class="carousel-caption">
								<i class="fa fa-star"></i> The performance bar appears <i class="fa fa-star"></i>
							</div>
						</div>
						<div class="item">
							<img src="images/howToUse_4.jpg" class="img-responsive" />
							<div class="carousel-caption">
								To get realistic results, clear cache before use.
							</div>
						</div>
					</div>

					<!-- Controls -->
					<a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
						<i class="glyphicon-chevron-left fa fa-chevron-left" aria-hidden="true"></i>
						<span class="sr-only">Previous</span>
					</a>
					<a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
						<i class="glyphicon-chevron-right fa fa-chevron-right" aria-hidden="true"></i> 
						<span class="sr-only">Next</span>
					</a>
				</div>
				
				<br />
				
				<h3>Enjoy your wingman.</h3>
				
				<!--
				<br />
				<br />
				
				<a href="https://github.com/thnew/insta-wingman/" class="btn-primary">
					<i class="fa fa-github"></i> View on GitHub
				</a>
				<!---->
			</div>
		</div>
		
		<div class="page_separator"></div>
		
		<footer class="container">
			<div class="row col-md-10 col-md-offset-1 col-xs-12 col-xs-offset-0">
				<span class="pull-right">
					go to <a href="?developer">developer mode</a> | by Thomas Heigl
				</span>
			</div>
		</footer>
		
		<div id="HowToAddModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">No Bro, you didn't click me! Did you?</h4>
					</div>
					<div class="modal-body">
						<p>You have to drag the button and drop it into your link bar!</p>
						
						<img class="img-responsive" src="images/explain.jpg" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Ok, got it!</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div id="HowToAddToMobile" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">How to add it to your smartphone</h4>
					</div>
					<div class="modal-body">
						<h5>
							Follow these instructions
						</h5>
						
						<ol id="MobileInstruction" class="s1">
							<li class="s1">1. Click this link: <a id="MobileLink" onclick="changeToStep(2)">INSTA Wingman</a></li>
							<li class="s2">
								2. Bookmark this page<br />
								<button class="btn" onclick="changeToStep(3)">ok, did it!</button>
							</li>
							<li class="s3">3.
								Edit the bookmark URL and remove everything up to and including the hash ("#")
								so that the bookmark URL starts with "javascript:"
								<br />
								Example:
								<br />
								<img class="img-responsive" src="images/mobileAddBokkmarkletExample.png" />
							</li>
						</ol>
						
						<h5>
							Or create a new bookmark with following URL
						</h5>
						
						<input class="form-control js_desktop_code_to_value" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Alright!</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div id="HowToUseModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">You didn't understand? Ok let me explain.</h4>
					</div>
					<div class="modal-body">
						<p>You go to a random webpage. Click at the bookmarklet. And that's it..</p>
						
						<img class="img-responsive" src="images/howToUse.jpg" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">Ahh, I understand!</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<script src="js/jquery.min.js" type="text/javascript"></script>
		<script src="js/bootstrap.min.js" type="text/javascript"></script>
		
		<script>
			(function(){
				function setJsLinks(content) {
					content = content.replace(new RegExp("\n", 'g'), "");
					content = content.replace(new RegExp("\t", 'g'), "");
					
					var linkElems = document.querySelectorAll(".js_desktop_code_to_href");
					for(var f in linkElems)
					{
						linkElems[f].href = content;
					}
					
					linkElems = document.querySelectorAll(".js_desktop_code_to_value");
					for(var f in linkElems)
					{
						linkElems[f].value = content;
					}
					
					document.querySelector("#MobileLink").href = "#" + content;
				};
				
				function scriptLoadFunctionConsole() {
					window.setTimeout(function(){
						/*UI*/ {
							/*Style*/ {
								var styleElem = document.createElement("style");
								styleElem.id = "instaConsoleStyle";
								
								var style = ".insta-console-wrapper { position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; overflow-y: scroll; padding: 10px; color: #2B2B2B; display: none; background:#fff; z-index: 100; }";
								
								style += ".insta-console_textarea { outline: none !important; min-height: 100px; width: 100%; border-radius: 3px; color: #2B2B2B; border-color: #2B2B2B; }";
								style += ".insta-console_execute { cursor: pointer; width: 100%; padding: 10px; background: transparent; border: 1px solid #2B2B2B; outline: 0px !important; border-radius: 3px; margin-top: 5px; min-height: 35px; }";
								style += ".insta-console_execute:hover { background: #2B2B2B; color: #fff; }";
								style += ".insta-console_execute:active { opacity: 0.9; }";
								
								style += ".insta-console_item { border: 1px solid rgba(0,0,0,0.1); border-radius: 3px; padding: 15px; margin-top: 10px }";
								style += ".insta-console_item.isActive { border-color: #2ECC71; }";
								style += ".insta-console_item.isActive .insta-console_item_remove { display: none !important; }";
								
								/*style += ".insta-console_item.insta-console_item-giveloveto:before { content: '\\2665'; margin-right: 5px; }";*/
								style += ".insta-console_item.insta-console_item-follow:before { content: '\\21D2'; margin-right: 5px; }";
								
								style += ".insta-console_item_remove { display: inline-block; float: right; cursor: pointer; }";
								style += ".insta-console_item_remove:before { content: 'remove'; }";
								
								style += ".insta-console-hide { position: absolute; top: 5px; right: 24px; z-index: 999; background: rgba(0,0,0,0.9); border-radius: 3px; cursor: pointer; color: #fff; padding: 5px; }";
								style += ".insta-console-hide:hover { background: rgba(0,0,0,0.5); }";
								style += ".insta-console-hide:after { content: 'hide' }";
								
								style += "body.show-insta-console { overflow: hidden; }";
								style += "body.show-insta-console .insta-console-wrapper { display: block; }";
								style += "body.show-insta-console .insta-console-hide:after { content: 'show console' }";
								
								styleElem.innerHTML = style;
								document.head.appendChild(styleElem);
							}
							
							var textarea = $("<textarea>")
								.attr("Id", "Commands")
								.addClass("insta-console_textarea")
								.keyup(function(e){
									if(e.keyCode == 13 && e.ctrlKey) {
										addCommandsFromTextArea();
									}
								});
							  
							var btn = $("<button>")
								.addClass("insta-console_execute")
								.text("Execute")
								.click(addCommandsFromTextArea);
							  
							var commandList = $("<div>")
								.attr("id", "CommandList")
								.width("100%")
								.css("padding", 0)
								.css("list-style-type", "none");
							
							$("<div>")
								.addClass("insta-console-wrapper")
								.append(textarea)
								.append(btn)
								.append(commandList)
								.appendTo("body");
							
							$("<div>")
								.addClass("insta-console-hide")
								.click(function() {
									$("body").toggleClass("show-insta-console");
								})
								.appendTo("body");
							
							$("body").addClass("show-insta-console");
						}
						
						/* Start listening for new commands */ {
							var taskActive = false;
							
							window.setInterval(function() {
								if(taskActive) return;
								
								var command = getNextCommand();
								
								if(command == null) {
									return;
								}
								
								taskActive = true;
								
								/*Flag item as active*/
								command.setActive(true);
								
								switch(command.getAction().toLowerCase()) {
									case "wait":
										var startTime = new Date().getTime();
										var waitInterval = window.setInterval(function() {
											var executeTime = new Date().getTime() - startTime;
											var remaining = command.getParam().waitTime - executeTime;
											
											if(remaining < 0) {
												window.clearInterval(waitInterval);
												
												command.remove();
												
												taskActive = false;
											}
											else {
												command.setArgs((Math.round(remaining / 1000)) + "s");
											}
										}, 100);
										break;
									case "like":
										performAction({ url: command.getParam().imageUrl, action: command.getAction(), command: command }, function() {
											command.remove();
											
											taskActive = false;
										});
										break;
									case "fill-console":
										performAction({ url: "https://www.instagram.com", action: command.getAction(), command: command }, function() {
											command.remove();
											
											taskActive = false;
										});
										break;
									case "follow":
									case "unfollow":
									case "giveloveto":
										var user = command.getParam().user;
										user.PerformAction(command.getAction(), command, function() {
											command.remove();
											
											taskActive = false;
										});
										break;
									case "export-followers":
									case "export-followers-details":
									case "export-following":
									case "export-following-details":
										var user = command.getParam().user;
										user.PerformAction(command.getAction(), command, function() {
											command.remove();
											
											taskActive = false;
										});
										break;
									case "export-home-users":
									case "export-home-users-details":
										performAction({ url: "https://www.instagram.com", action: command.getAction(), command: command }, function() {
											command.remove();
											
											taskActive = false;
										});
										break;
									default:
										console.log("Command '" + command.getAction() + "' not recognized!");
										
										command.remove();
										
										taskActive = false;
										break;
								}
							}, 10);
						}
					}, 0);
					
					/* Functions */ {
						/* Helper */ {
							var INT_MAX = Math.pow(2,32);
							
							var getMilliseconds = function() {
								return Date.UTC(0,0,0,0,new Date().getMinutes(),new Date().getSeconds());
							};
						}
						
						/* Returns the next command to be executed */
						function getNextCommand() {
							var item = $("#CommandList").children().first();
							
							if(item.length == 0) {
								return null;
							}
							
							return {
								setAction: function(action) {
									item.data("action", action);
									$(".item_action", item).text(action);
								},
								setArgs: function(args) {
									item.data("args", args);
									$(".item_args", item).text(args);
								},
								setActive: function(isActive) {
									$(item).toggleClass("isActive", isActive);
								},
								
								getAction: function() {
									return $(".item_action", item).text();
								},
								getArgs: function() {
									return $(".item_args", item).text();
								},
								getParam: function() {
									return item.data("param");
								},
								
								remove: function() {
									item.remove();
								}
							};
						}
						
						/* Add commands to command list */
						function addCommand(action, args, param, prepend) {
							var commandList = $("#CommandList");
							
							var item = $("<li>")
								.data("action", action)
								.data("args", args)
								.data("param", param)
								.addClass("insta-console_item")
								.addClass("insta-console_item-" + action);
							
							if(prepend) {
								item.prependTo(commandList);
							}
							else {
								item.appendTo(commandList);
							}
							
							var title = $("<h1>")
								.css("font-size", "inherit")
								.css("display", "inline-block")
								.css("margin", "0px")
								.css("font-weight", "inherit")
								.appendTo(item);
							
							var actionSpan = $("<span>")
								.addClass("item_action")
								.text(action)
								.appendTo(title);
							
							$("<span>")
								.text(" ")
								.appendTo(title);
							
							var argsSpan = $("<span>")
								.addClass("item_args")
								.text(args)
								.appendTo(title);
							
							var removeBtn = $("<aside>")
								.addClass("insta-console_item_remove")
								.click(function() {
									item.remove();
								})
								.appendTo(item);
							
							return getNextCommand();
						};
						
						/* Download a given list of user-objects as a CSV-file */
						function downloadUsersAsCsv(users) {
							if(users.length == 0) {
								alert("No users found to download!");
								return;
							}
							
							console.log("Build data");
							var header = users[0].GetHeaderAttributes();
							
							var usersArray = [];
							for(var f in users) {
								var user = users[f];
								var userAsAnArray = [];
								
								for(var g in header) {
									attrName = header[g];
									userAsAnArray.push(user[attrName]);
								}
								
								usersArray.push(userAsAnArray);
							}
							
							console.log("Build CSV");
							var csvContent = header.join(";") + "\n";
							usersArray.forEach(function(infoArray, index){
								dataString = infoArray.join(";");
								csvContent += dataString+ "\n";
							});
							
							console.log("Download");
							var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
							var link = document.createElement("a");
							var url = URL.createObjectURL(blob);
							link.setAttribute("href", url);
							link.setAttribute("download", 'data.csv');
							link.style.visibility = 'hidden';
							document.body.appendChild(link);
							link.click();
							document.body.removeChild(link);
						};
						
						/* Reads all users from the feed object and returns user-objects */
						var getUsersFromFeed = function(iFrame) {
							var frameWindow = document.getElementById(iFrame.attr("id")).contentWindow;
							
							var allUsers = [];
							var feedMedia = frameWindow._sharedData.entry_data.FeedPage.pop().feed.media.nodes;
							
							/* Go through the own feed */
							for(var f in feedMedia) {
								var media = feedMedia[f];
								allUsers.push(new User({
									Name: media.owner.username
								}));
								
								/* Go through the likes of the media */
								for(var g in media.likes.nodes) {
									var like = media.likes.nodes[g];
									
									allUsers.push(new User({
										Name: like.user.username
									}));
								}
							}
							
							return allUsers;
						};
						
						/* Takes a list of user objects and loads their details step by step */
						function loadAllUserInfos(userList, callback) {
							var usersToLoad = userList.length;
							
							for(var f in userList) {
								var user = userList[f];
								
								user.LoadInfo(function(resp) {
									if(--usersToLoad == 0) {
										console.log("loadAllUserInfos() - All users loaded!");
										callback(userList);
										return;
									}
									
									console.log("loadAllUserInfos() - Load " + usersToLoad + " more users.");
								});
							}
						};
						
						/* Loads a lazy loading list till teh end and returns its users as user-objects */
						function loadFrontendList(parentObj, type, listLoadCallback) {
							/*Find out the list button Id for the given user type*/
							var buttonToClick;
							switch(type) {
								case "followers":
									buttonToClick = $("._pr3wx", parentObj);
									break;
								case "following":
									buttonToClick = $("._bgvpv", parentObj);
									break;
								default:
									alert("loadFrontendList() Type " + type + " not found!");
									return;
							}
							
							buttonToClick.click();
							
							window.setTimeout(function() {
								/* list */
								var userListElem = $("._4j13h", parentObj);
								
								var scrollContainer = $("._4gt3b", parentObj);
								
								var getFollowButtons = function() {
									return $("._csba8[data-reactid]", userListElem);
								};
								
								var followTwentyUsers = function() {
									getFollowButtons().slice(0, 20).click();
								};
								
								var getUsers = function() {
									var users = [];
									
									/* Go through the list and grab all the user names */
									$("._4zhc5", userListElem).each(function(index, value){
										var elem = $(value);
										var name = elem.text();
										
										users.push(new User({
											Name: name
										}));
									});
									
									return users;
								};
								
								var countUsers = function() {
									return $("._4zhc5", userListElem).length;
								};
								
								var scrollWindowDown = function() {
									console.log("scrollWindowDown()");
									scrollContainer.scrollTop(Math.pow(2,32));
								};
								
								/*Scroll down as long as new followers appear or the wanted amount is reached*/
								function loadUsers(usersToLoad, updateCallback, successCallback) {
									var amountOfUsers = 0;
									if(amountOfUsers < usersToLoad)
									{
										var maxWaitingTime = 2000;
										
										var lastSuccessTime = getMilliseconds();
										
										/* Watch */
										var interval = window.setInterval(function(){
											console.log("Check");
											
											var timeSinceLastSuccess = getMilliseconds() - lastSuccessTime;
											
											var userCount = countUsers();
											
											if(userCount > amountOfUsers) {
												lastSuccessTime = getMilliseconds();
												amountOfUsers = userCount;

												updateCallback(amountOfUsers);
												
												if(amountOfUsers >= usersToLoad) {
													window.clearInterval(interval);
													successCallback(amountOfUsers);
													return;
												}
												
												console.log("Too less users: " + amountOfUsers + ". Try to load more users.");
												scrollWindowDown();
												return;
											}
											
											if(timeSinceLastSuccess > maxWaitingTime) {
												window.clearInterval(interval);
												successCallback(amountOfUsers);
												return;
											}
										}, 50);
									}
								};
								
								function loadAllUserInfos(userList, callback) {
									var usersToLoad = userList.length;
									
									for(var f in userList) {
										var user = userList[f];
										
										user.LoadInfo(function(resp) {
											if(--usersToLoad == 0) {
												console.log("loadAllUserInfos() - All users loaded!");
												callback(userList);
												return;
											}
											
											console.log("loadAllUserInfos() - Load " + usersToLoad + " more users.");
										});
									}
								};
								
								loadUsers(INT_MAX, function(usersLoaded) {
									$("._q44m8 span", parentObj).remove();
									$("._q44m8", parentObj).append($("<span>").text(usersLoaded + " users loaded."));
								}, function(usersLoaded) {
									var users = getUsers();
									
									listLoadCallback(users);
								});
							}, 1000);
						}
						
						/*Shuffle an array*/
						function shuffle(a) {
							var j, x, i;
							for (i = a.length; i; i -= 1) {
								j = Math.floor(Math.random() * i);
								x = a[i - 1];
								a[i - 1] = a[j];
								a[j] = x;
							}
						}
						
						/* Perform an console action */
						function performAction(config, callback) {
							console.log("performAction('" + config.url + "', '" + config.action + "', " + typeof(callback) + ")");
							console.log("Config object", config);
							
							/* If the IFrame doesn't load, remove it after a time */
							var timeout = window.setTimeout(function() {
								console.log("The action will be exited cause of a timeout");
								
								wrapper.remove();

								callback();
							}, 30000);
							
							var iFrame = $("<iframe>")
								.attr("Id", "InstaWindow")
								.attr("src", config.url)
								.css("z-index", 501)
								.css("border", "0px")
								.height("100%")
								.width("100%")
								.load(function(){
									if(timeout == null) {
										console.log("I won't execute cause the Timeout was already executed");
										return;
									}
									
									/*Clear the timeout*/
									window.clearTimeout(timeout);
									
									/*Wait till the page is fully built up*/
									window.setTimeout(function() {
										/*Function to call to go on*/
										function next() {
											window.setTimeout(function() {
												wrapper.remove();
												
												callback();
											}, 1000);
										}
										
										/*Try to execute the action*/
										var iframe = $("#InstaWindow");
										
										try {
											var iFrameContent = iframe.contents();
											
											switch(config.action.toLowerCase()) {
												case "export-home-users":
													isOneTimeAction= true;
												
													var users = getUsersFromFeed(iframe);
													
													console.log("Found users:", users);
													
													/* Start download */
													downloadUsersAsCsv(users);
													
													/*Continue*/
													next();
													break;
												case "export-home-users-details":
													var users = getUsersFromFeed(iframe);
													
													console.log("Found users:", users);
													
													loadAllUserInfos(users, function(users) {
														console.log("Users", users);
														
														/* Start download */
														downloadUsersAsCsv(users);
														
														/*Continue*/
														next();
													});
													break;
												
												case "export-followers":
													loadFrontendList(iFrameContent, "followers", function(users) {
														console.log("Users", users);
														
														/* Start download */
														downloadUsersAsCsv(users);
														
														/*Continue*/
														next();
													});
													break;
												case "export-followers-details":
													loadFrontendList(iFrameContent, "followers", function(users) {
														console.log("Users", users);
														
														loadAllUserInfos(users, function(users) {
															console.log("Users", users);
															
															/* Start download */
															downloadUsersAsCsv(users);
															
															/*Continue*/
															next();
														});
													});
													break;
													
												case "export-following":
													loadFrontendList(iFrameContent, "following", function(users) {
														console.log("Users", users);
														
														/* Start download */
														downloadUsersAsCsv(users);
														
														/*Continue*/
														next();
													});
													break;
												case "export-following-details":
													loadFrontendList(iFrameContent, "following", function(users) {
														console.log("Users", users);
														
														loadAllUserInfos(users, function(users) {
															console.log("Users", users);
															
															/* Start download */
															downloadUsersAsCsv(users);
															
															/*Continue*/
															next();
														});
													});
													break;
												
												case "giveloveto":
													var media = $("._8mlbc", iFrameContent);
													
													var potentialTasks = [];
													
													media.each(function(key, value){
														href = $(value).attr("href");
														
														potentialTasks.push({
															action:		"like",
															imageUrl:	"https://www.instagram.com" + href
														});
													});
													
													/* Between 2 and 4 */
													var amountOfImagesToLike = Math.round(Math.random()*2 + 2);
													var stepSize = Math.round(potentialTasks.length / amountOfImagesToLike);
													if(stepSize == 0) stepSize = 1;
													stepSize = 999; /*Make it temporarily big to let just one photo be liked*/

													for(var i=0; i<potentialTasks.length; i+=stepSize) {
														var task = potentialTasks[i];
														addCommand(task.action, task.imageUrl, { imageUrl: "https://www.instagram.com" + href }, true);
													}
													
													/*Add waiting time*/
													var waitTime = Math.round(Math.random() * 21 + 5);
													if(waitTime == 25) waitTime = Math.round(Math.random() * 20 + 50);
													addCommand("wait", waitTime + "s", { waitTime: waitTime * 1000 }, true);
													
													/*Continue*/
													next();
													break;
												
												case "fill-console":
													var commands = [];
													
													/*var max = config.command.getParam().max || INT_MAX;*/
													maxUsers = 100;
													
													var users = getUsersFromFeed(iframe).slice(0, maxUsers);
													
													loadAllUserInfos(users, function(users) {
														console.log("Users", users);
														
														/*Get follow commands*/
														if(config.command.getParam().args_1 != "giveloveto") {
															for(var f in users) {
																var user = users[f];
																
																/*Cause of this target group will unfollow you just between 30% and 50% after you unfollow them*/
																if(user.Followers < 400 && user.Follows < 400 && user.Posts > 3) {
																	commands.push({
																		action: "follow",
																		args: user.Name,
																		parameters: { user: new User({ Name: user.Name }) }
																	});
																}
															}
														}
														
														/*Get giveloveto commands*/
														if(config.command.getParam().args_1 != "follow") {
															for(var f in users) {
																var user = users[f];
																
																/*Cause too big instagrammers won't recognize yur likes*/
																if(user.Followers < 2000 && user.Follows < 1000 && user.Posts > 1) {
																	commands.push({
																		action: "giveloveto",
																		args: user.Name,
																		parameters: { user: new User({ Name: user.Name }) }
																	});
																}
															}
														}
														
														/*Shuffle all commands*/
														shuffle(commands);
														
														/*Add waiting time every 10 follow commands*/
														var followCount = 0;
														for(var f in commands) {
															var command = commands[f];
															
															if(command.action == "follow") {
																followCount++;
															}
															
															if(followCount == 10) {
																commands.splice(f, 0, {
																	action: "wait",
																	args: "900s",
																	parameters: { waitTime: 900 * 1000 }
																});
																
																followCount = 0;
															}
														}
														console.log(config.command);
														/*If it should be repeated, add command*/
														if(config.command.getParam().args_1 == "repeat") {
															console.log("Repeat fill-console");
															commands.push({
																action: "fill-console",
																args: "repeat",
																parameters: config.command.getParam()
															});
														}
														
														/*Add all commands*/
														for(var i = commands.length - 1; i >= 0; i--) {
															var command = commands[i];
															
															addCommand(command.action, command.args, command.parameters, true);
														}
														
														/*Continue*/
														next();
													});
													break;
													
												case "like":
													var likeBtn = $("._1tv0k > span[class~='whiteoutSpriteHeartOpen']", iFrameContent);
													
													if(likeBtn.length == 0) {
														console.log("Like button not found");
													}
													
													likeBtn.click();
													
													/*Continue*/
													next();
													break;
												case "follow":
													var btn = $("._2hpcs", iFrameContent);
													
													if(btn.length == 0) {
														console.log("Follow button not found");
													}
													
													btn.click();
													
													/*Continue*/
													next();
													break;
												case "unfollow":
													var btn = $("._r4e4p", iFrameContent);
													
													if(btn.length == 0) {
														console.log("Unfollow button not found");
													}
													
													btn.click();
													
													/*Continue*/
													next();
													break;
												default:
													console.log("Action " + action.toLowerCase() + " not found");
											}
										}
										catch(e) {}
									}, 1000);
								});
							
							var overlay = $("<div>")
								.css("position", "absolute")
								.css("top", "0px")
								.css("left", "0px")
								.css("right", "0px")
								.css("bottom", "0px")
								.css("z-index", 502)
								.css("text-align", "center")
								.css("color", "rgba(0,0,0,0,8)")
								.css("padding-top", "70px")
								.css("font-family", "Arial")
								.text(config.action.toLowerCase())
								.css("background-color", "rgba(255,255,255,0.8)");
							
							var wrapper = $("<div>")
								.attr("id", "IFrameWindowWrapper")
								.append(iFrame)
								.append(overlay)
								.css("position", "fixed")
								.css("top", "0px")
								.css("right", "0px")
								.css("z-index", 500)
								.width(550)
								.height(550);
							
							console.log("Append the IFrame");
							$("body").append(wrapper);
						}
						
						/* Takes the text commands and pushes them into the list of tasks */
						function addCommandsFromTextArea() {
							var textarea = $("#Commands");
							var commands = textarea.val().split("\n");
							
							console.log(commands.length + " text commands found.");
							
							/*Clear the textarea*/
							textarea.val("");
							
							for(var f in commands) {
								var command = commands[f];
								var parts = command.split(" ");

								var action = parts[0].toLowerCase();

								switch(action) {
									/*They take one optional parameter*/
									case "fill-console":
										var args_1 = parts.length > 1 ? parts[1] : "";
										var max = parts.length > 2 ? parts[2] : "";
										
										addCommand(action, args_1 + " " + max, { args_1: args_1, INT_MAX, max: max });
										break;
										
									/*They don't need any parameters*/
									case "export-home-users":
									case "export-home-users-details":
										addCommand(action, "");
										break;
									
									/*Their only parameter is the username*/
									case "follow":
									case "unfollow":
									case "export-followers":
									case "export-followers-details":
									case "export-following":
									case "export-following-details":
									case "giveloveto":
										var username = parts.length > 1 ? parts[1] : null;
										
										if(username == null) {
											alert("Command '" + command + "' not recognized!");
											break;
										}
										
										addCommand(action, username, { user: new User({ Name: username }) });
										break;
									
									/*This is especially for wait*/
									case "wait":
										var waitTime = parts.length > 1 ? parts[1] * 1.0 : null;
										
										if(!$.isNumeric(waitTime) || waitTime == null) {
											console.log("Command '" + command + "' not recognized!");
											break;
										}
										
										addCommand(action, waitTime + "s", { waitTime: waitTime * 1000 });
										break;
									default:
										console.log("Command '" + command + "' not recognized!");
								}
							}
						}
					}
					
					/* Classes */ {
						/* Semaphore */ {
							function Semaphore(capacity) {
								var semaphore = {
									capacity: capacity || 1,
									current: 0,		
									queue: [],

									take: function() {
										var item = { n: 1 };

										if (typeof arguments[0] == 'function') item.task = arguments[0];
										else if (typeof arguments[0] == 'object') item.args = arguments[0];
										else item.n = arguments[0];

										if (arguments.length == 2)  {
											if (typeof arguments[1] == 'function') item.task = arguments[1];
											else if (typeof arguments[1] == 'object') item.args = arguments[1];
											else item.n = arguments[1];
										}
										
										if (arguments.length == 3)  {
											if (typeof arguments[2] == 'function') item.task = arguments[2];
											else if (typeof arguments[2] == 'object') item.args = arguments[2];
											else item.n = arguments[2];
										}

										if (semaphore.current + item.n > semaphore.capacity) {
											return semaphore.queue.push(item);
										}

										semaphore.current += item.n;
										item.task(item.args);
									},

									leave: function(n) {
										n = n || 1;

										semaphore.current -= n;
										
										if (!semaphore.queue.length) {
											if (semaphore.current < 0) {
												throw new Error('leave called too many times.');
											}

											return;
										}

										var item = semaphore.queue[0];

										if (item.n + semaphore.current > semaphore.capacity) {
											return;
										}

										semaphore.queue = semaphore.queue.splice(1);
										semaphore.current += item.n;
										
										item.task(item.args);
									}
								};

								return semaphore
							};
						}
						
						/* Class User */ {
							function User(attr) {
								for(var f in attr) {
									this[f] = attr[f];
								}
								
								this.Url = "https://www.instagram.com/" + attr.Name;

								/*Some commands*/
								this.CmdUnfollow = "unfollow " + attr.Name;
								this.CmdFollow = "follow " + attr.Name;
								this.CmdGiveLoveTo = "giveloveto " + attr.Name;
							};
							
							User.prototype = {
								Name: null,
								Url: null,
								IsPrivate: null,
								
								Posts: null,
								Followers: null,
								Follows: null,
								
								MostLikesOnFirstPage: null,
								TotalLikesOnFirstPage: null,

								/*Commands*/
								CmdUnfollow: null,
								CmdFollow: null,
								CmdGiveLoveTo: null,
								
								Semaphore: new Semaphore(1),
								
								GetHeaderAttributes: function() {
									return [
										"Name",
										"Url",
										"Posts",
										"Followers",
										"Follows",
										"IsPrivate",
										"MostLikesOnFirstPage",
										"TotalLikesOnFirstPage",
										"CmdUnfollow",
										"CmdFollow",
										"CmdGiveLoveTo"
									];
								},
								
								PerformAction: function(action, command, callback) {
									console.log("Perform action '" + action + "' on " + this.Url);
									performAction({ url: this.Url, action: action, command: command }, callback);
								},
								
								LoadInfo: function(callback) {
									var me = this;
									
									me.Semaphore.take(function() {
										$.get(me.Url, function(resp) {
												console.log("Analyze " + me.Name);
												
											var sharedData = resp.split("window._sharedData =");
											sharedData = sharedData.pop();
											sharedData = sharedData.split(";<\/script>")[0];
											sharedData = sharedData.trim();
												
											try {
												sharedData = JSON.parse(sharedData);
											}
											catch(e) {
												console.log("LoadInfo() - response sharedData could not be JSON parsed: ", sharedData);
													
												callback({
													success: false,
													data: me
												});
											}
												
											var user = sharedData.entry_data.ProfilePage[0].user;
												
											resp = $(resp);
												
											me.Posts = user.media.count;
											me.Followers = user.followed_by.count;
											me.Follows = user.follows.count;
												me.IsPrivate = user.is_private;
												
												if(!me.IsPrivate) {
											var mostLikes = 0;
											var totalLikes = 0;
											for(var f in user.media.nodes) {
												var media = user.media.nodes[f];
												if(media.likes.count > mostLikes) {
													mostLikes = media.likes.count;
												}
														
												totalLikes += media.likes.count;
											}
													
											me.MostLikesOnFirstPage = mostLikes;
											me.TotalLikesOnFirstPage = totalLikes;
												}
												
											callback({
												success: true,
												data: me
											});
												
												me.Semaphore.leave();
											}).fail(function() {
											callback({
												success: false,
												data: null
											});
												
												me.Semaphore.leave();
										});
									});
								}
							};
						}
					}
				};
				
				setJsLinks('javascript:(' + scriptLoadFunctionConsole + ')();');
				
				(function preparePage() {
					/*Get GET-parameters*/ {
						var _GET = {};
						var parts = location.href.split("?");
						
						if(parts.length > 1)
						{
							parts = parts.pop();
							parts = parts.split("#")[0];
							parts = parts.split("&");
							
							for(var f in parts)
							{
								var p = parts[f].split("=");
								
								_GET[p[0]] = (p.length > 1 ? p[1] : true);
							}
						}
					}
					
					// If developer set, modify bookmarklet URL
					if(_GET["developer"] != null)
					{
						setJsLinks('javascript:var isDevelopmentMode=true; ' + scriptLoadFunction + '; scriptLoadFunction("https://thnew.github.io/insta-wingman/public/bookmarklet.js");');
						
						document.querySelector("#DesktopLink").innerHTML += " DEV";
						
						// Show visually, that this is the developer mode
						var logoSub = $(".logo span");
						
						logoSub.css("font-size", 10);
					}
					
					if(_GET["developer"] == null)
					{
						var dragLink = document.querySelector("#DragLink");
						dragLink.onclick = function() {
							var style = document.createElement("style");
							style.innerHTML += "#PerfBar { display: none !important; }";
							document.head.appendChild(style);
							
							$("#HowToAddModal").modal();
						};
					}
					
					$(".explain").click(function() {
						$("#HowToUseModal").modal();
					});
				})();
			})();
			
			function changeToStep(nr){
				document.querySelector("#MobileInstruction").className = "s" + nr;
			}
		</script>
	</body>
</html>